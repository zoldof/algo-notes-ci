name: Build and push only changed files
on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build site
        run: |
          # 例: Jekyll ビルド → _site に出力
          jekyll build -s . -d _site
      - name: Gather changed files
        id: gather
        run: |
          mkdir -p changed
          cd _site
          # 変更があったファイルだけを抽出
          git diff --name-only HEAD > /tmp/changed.txt || true
          while IFS= read -r f; do
            mkdir -p "../changed/$(dirname "$f")"
            cp -a "$f" "../changed/$f"
          done < /tmp/changed.txt
      - name: Upload changed artifact
        uses: actions/upload-artifact@v4
        with:
          name: changed-artifact          # ← ここと download 側の名前を合わせる
          path: changed/**/*
          if-no-files-found: warn        # 変更が無いときは警告で分かる

  push:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download changed artifact
        uses: actions/download-artifact@v4
        with:
          name: changed-artifact          # ← 同じ名前
          path: changed-artifact
          # repository と run-id は省略 → 同じ Run のアーティファクトを取得
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: zoldof/algo-notes
          token: ${{ secrets.PAT_FOR_TARGET }}
          path: target-repo
      - name: Copy and push
        run: |
          cp -r changed-artifact/* target-repo/
          cd target-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "Deploy $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            git push origin HEAD:main
          else
            echo "No changes"
          fi
