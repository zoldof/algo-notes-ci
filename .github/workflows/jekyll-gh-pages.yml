name: Build and push selected artifacts

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source (ci repo)
        uses: actions/checkout@v4

      - name: Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: Archive selected directories
        run: |
          mkdir -p artifacts
          tar -czf artifacts/site.tar.gz -C _site dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-artifact
          path: artifacts/site.tar.gz

  push:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: site-artifact
          path: .

      - name: Checkout target repo (cd repo)
        uses: actions/checkout@v4
        with:
          repository: zoldof/algo-notes
          token: ${{ secrets.PAT_FOR_TARGET }}
          path: target-repo

      - name: Extract selected files into target repo root
        run: |
          tar -xzf site.tar.gz -C target-repo
          if [ -d "target-repo/dist" ]; then
            rsync -a --delete target-repo/dist/ target-repo/
            rm -r target-repo/dist
          fi

          cd target-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "Deploy selected artifacts $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            git push origin HEAD:main
          fi
